openapi: 3.1.0
info:
  title: GreenData API
  version: 1.0.0
servers:
  - url: http://localhost:3000/api/v1
  - url: http://localhost:3000
paths:
  /plants:
    get:
      summary: List plants
      parameters:
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: offset
          schema: { type: integer, minimum: 0, default: 0 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkPlantList" }
              examples:
                ok:
                  value:
                    data:
                      items:
                        - _id: "64f1a2b3c4d5e6f7a8b9c0d1"
                          name: "Tomate"
                          type: "Solanum lycopersicum"
                          createdAt: "2025-11-01T12:00:00.000Z"
                      total: 1
                      limit: 20
                      offset: 0
    post:
      summary: Create plant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PlantCreate"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkPlant" }
              examples:
                created:
                  value:
                    data:
                      _id: "64f1a2b3c4d5e6f7a8b9c0d1"
                      name: "Albahaca"
                      type: "Ocimum basilicum"
                      createdAt: "2025-11-01T12:00:00.000Z"
        "400": { $ref: "#/components/responses/BadRequest" }
  /plants/{id}:
    get:
      summary: Get plant
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkPlant" }
        "404": { $ref: "#/components/responses/NotFound" }
    patch:
      summary: Update plant
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PlantUpdate"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkPlant" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      summary: Delete plant
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        "200": { $ref: "#/components/responses/OkDeleted" }
        "404": { $ref: "#/components/responses/NotFound" }
  /plants/{plantId}/sensors:
    get:
      summary: List sensors for plant
      parameters:
        - in: path
          name: plantId
          required: true
          schema: { type: string }
        - in: query
          name: type
          schema: { type: string, enum: [humidity, ph, temp, lux] }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100, default: 50 }
        - in: query
          name: offset
          schema: { type: integer, minimum: 0, default: 0 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkSensorList" }
        "404": { $ref: "#/components/responses/NotFound" }
    post:
      summary: Create sensor for plant
      parameters:
        - in: path
          name: plantId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SensorCreate"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkSensor" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "404": { $ref: "#/components/responses/NotFound" }
  /sensors/{sensorId}:
    get:
      summary: Get sensor
      parameters:
        - in: path
          name: sensorId
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkSensor" }
        "404": { $ref: "#/components/responses/NotFound" }
    patch:
      summary: Update sensor
      parameters:
        - in: path
          name: sensorId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SensorUpdate"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkSensor" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      summary: Delete sensor
      parameters:
        - in: path
          name: sensorId
          required: true
          schema: { type: string }
      responses:
        "200": { $ref: "#/components/responses/OkDeleted" }
        "404": { $ref: "#/components/responses/NotFound" }
  /sensors/{sensorId}/threshold:
    get:
      summary: Get threshold
      parameters:
        - in: path
          name: sensorId
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkThreshold" }
        "404": { $ref: "#/components/responses/NotFound" }
    put:
      summary: Upsert threshold
      parameters:
        - in: path
          name: sensorId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Threshold"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkThreshold" }
    delete:
      summary: Delete threshold
      parameters:
        - in: path
          name: sensorId
          required: true
          schema: { type: string }
      responses:
        "200": { $ref: "#/components/responses/OkDeleted" }
  /alerts:
    get:
      summary: List alerts
      parameters:
        - in: query
          name: plantId
          schema: { type: string }
        - in: query
          name: sensorId
          schema: { type: string }
        - in: query
          name: from
          schema: { type: string, format: date-time }
        - in: query
          name: to
          schema: { type: string, format: date-time }
        - in: query
          name: limit
          schema: { type: integer }
        - in: query
          name: level
          schema: { type: string, enum: [normal, grave, critica] }
        - in: query
          name: status
          schema: { type: string, enum: [pendiente, en_progreso, completado] }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkAlertList" }
  /alerts/{id}/status:
    patch:
      summary: Update alert status
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [pendiente, en_progreso, completado]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkAlert" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "404": { $ref: "#/components/responses/NotFound" }
  /alerts/{id}/ack:
    patch:
      summary: Acknowledge alert (sets status to completado)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                by: { type: string, description: User identifier }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkAlert" }
        "404": { $ref: "#/components/responses/NotFound" }
  /sensors/history:
    get:
      summary: Sensor history
      parameters:
        - in: query
          name: plant
          required: true
          schema: { type: string }
        - in: query
          name: sensor
          required: true
          schema:
            type: string
            enum: [humidity, ph, temp, lux]
        - in: query
          name: limit
          schema: { type: integer }
        - in: query
          name: from
          schema: { type: string, format: date-time }
        - in: query
          name: to
          schema: { type: string, format: date-time }
        - in: query
          name: maxPoints
          schema: { type: integer }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkHistorySeries" }
        "400": { $ref: "#/components/responses/BadRequest" }
  /sensors/history/agg:
    get:
      summary: Aggregated sensor history (fixed step)
      parameters:
        - in: query
          name: plant
          required: true
          schema: { type: string }
        - in: query
          name: sensor
          required: true
          schema:
            type: string
            enum: [humidity, ph, temp, lux]
        - in: query
          name: from
          schema: { type: string, format: date-time }
        - in: query
          name: to
          schema: { type: string, format: date-time }
        - in: query
          name: step
          schema: { type: string, enum: ["1m", "5m", "1h"], default: "1m" }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkAggSeries" }
        "400": { $ref: "#/components/responses/BadRequest" }
  /sensors/daily:
    get:
      summary: Daily aggregates (min/avg/max) by day
      parameters:
        - in: query
          name: plant
          required: true
          schema: { type: string }
        - in: query
          name: sensor
          required: true
          schema:
            type: string
            enum: [humidity, ph, temp, lux]
        - in: query
          name: from
          schema: { type: string, format: date-time }
        - in: query
          name: to
          schema: { type: string, format: date-time }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkDailyAggregates" }
        "400": { $ref: "#/components/responses/BadRequest" }
  /readings:
    post:
      summary: Insert single reading
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Reading"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkInserted" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "429": { $ref: "#/components/responses/TooManyRequests" }
  /readings/batch:
    post:
      summary: Insert batch of readings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                readings:
                  type: array
                  items:
                    $ref: "#/components/schemas/Reading"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ApiOkInserted" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "429": { $ref: "#/components/responses/TooManyRequests" }
  /health:
    get:
      summary: Health (dependencies)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  mongo: { type: object, properties: { ok: { type: boolean } } }
                  cassandra:
                    { type: object, properties: { ok: { type: boolean } } }
  /health/live:
    get:
      summary: Liveness
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { type: object, properties: { ok: { type: boolean } } }
  /health/ready:
    get:
      summary: Readiness
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  mongo: { type: object, properties: { ok: { type: boolean } } }
                  cassandra:
                    { type: object, properties: { ok: { type: boolean } } }
  /metrics:
    get:
      summary: Prometheus metrics
      responses:
        "200":
          description: OK (text/plain; OpenMetrics format)
          content:
            text/plain:
              schema:
                type: string
components:
  schemas:
    ApiError:
      type: object
      properties:
        error: { type: string }
        details: { nullable: true }
    ApiOkInserted:
      type: object
      properties:
        data:
          type: object
          properties:
            inserted: { type: integer }
      example: { data: { inserted: 2 } }
    ApiOkPlantList:
      type: object
      properties:
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/Plant" }
            total: { type: integer }
            limit: { type: integer }
            offset: { type: integer }
    ApiOkPlant:
      type: object
      properties:
        data: { $ref: "#/components/schemas/Plant" }
    ApiOkSensorList:
      type: object
      properties:
        data:
          type: object
          properties:
            items:
              type: array
              items: { $ref: "#/components/schemas/Sensor" }
            total: { type: integer }
            limit: { type: integer }
            offset: { type: integer }
    ApiOkSensor:
      type: object
      properties:
        data: { $ref: "#/components/schemas/Sensor" }
    ApiOkThreshold:
      type: object
      properties:
        data:
          anyOf:
            - $ref: "#/components/schemas/Threshold"
            - type: "null"
    ApiOkAlertList:
      type: object
      properties:
        data:
          type: array
          items: { $ref: "#/components/schemas/Alert" }
    ApiOkAlert:
      type: object
      properties:
        data: { $ref: "#/components/schemas/Alert" }
    ApiOkHistorySeries:
      type: object
      properties:
        data:
          type: array
          items: { $ref: "#/components/schemas/HistoryPoint" }
    ApiOkAggSeries:
      type: object
      properties:
        data:
          type: array
          items: { $ref: "#/components/schemas/AggPoint" }
    ApiOkDailyAggregates:
      type: object
      properties:
        data:
          type: array
          items: { $ref: "#/components/schemas/DailyAggregate" }
    PlantCreate:
      type: object
      required: [name]
      properties:
        name: { type: string }
        type: { type: string }
    Plant:
      type: object
      properties:
        _id: { type: string }
        name: { type: string }
        type: { type: string, nullable: true }
        createdAt: { type: string, format: date-time, nullable: true }
    PlantUpdate:
      type: object
      properties:
        name: { type: string }
        type: { type: string }
    SensorCreate:
      type: object
      required: [type]
      properties:
        type: { type: string, enum: [humidity, ph, temp, lux] }
        unit: { type: string }
    SensorUpdate:
      type: object
      properties:
        type: { type: string, enum: [humidity, ph, temp, lux] }
        unit: { type: string }
    Sensor:
      type: object
      properties:
        _id: { type: string }
        plantId: { type: string }
        type: { type: string, enum: [humidity, ph, temp, lux] }
        unit: { type: string, nullable: true }
        createdAt: { type: string, format: date-time, nullable: true }
    Threshold:
      type: object
      required: [min, max]
      properties:
        min: { type: number }
        max: { type: number }
        hysteresis: { type: number }
    Reading:
      type: object
      required: [plant, sensorType, sensorId, value]
      properties:
        plant: { type: string }
        sensorType: { type: string, enum: [humidity, ph, temp, lux] }
        sensorId: { type: string }
        value: { type: number }
        ts: { oneOf: [{ type: string, format: date-time }, { type: number }] }
    Alert:
      type: object
      properties:
        _id: { type: string }
        plantId: { type: string }
        sensorId: { type: string }
        value: { type: number }
        level: { type: string, enum: [grave, critica] }
        status: { type: string, enum: [pendiente, en_progreso, completado] }
        message: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
    HistoryPoint:
      type: object
      properties:
        tsISO: { type: string, format: date-time }
        value: { type: number }
    AggPoint:
      type: object
      properties:
        tsISO: { type: string, format: date-time }
        min: { type: number, nullable: true }
        avg: { type: number, nullable: true }
        max: { type: number, nullable: true }
        count: { type: integer }
    DailyAggregate:
      type: object
      properties:
        dayISO: { type: string }
        min: { type: number, nullable: true }
        avg: { type: number, nullable: true }
        max: { type: number, nullable: true }
        count: { type: integer }
  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ApiError" }
          examples:
            bad:
              value: { error: "Invalid sensorId" }
    NotFound:
      description: Not Found
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ApiError" }
          examples:
            nf:
              value: { error: "Alert not found" }
    TooManyRequests:
      description: Too Many Requests
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ApiError" }
          examples:
            rate:
              value: { error: "Too many requests, please try again later." }
    OkDeleted:
      description: OK
      content:
        application/json:
          schema:
            type: object
            properties:
              data:
                type: object
                properties:
                  deleted: { type: boolean }
          examples:
            ok:
              value: { data: { deleted: true } }
